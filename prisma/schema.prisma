// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema
// https://www.prisma.io/docs/reference/api-reference/prisma-schema-reference#mysql
// https://www.prisma.io/docs/concepts/components/prisma-client/working-with-fields/working-with-json-fields

generator client {
    provider = "prisma-client-js"
}

datasource db {
    provider = "mysql"
    url      = env("DATABASE_URL")
    relationMode = "prisma"
}

// https://clerk.com/docs/users/sync-data-to-your-backend
model TeacherProfile {
    id            String    @id @default(cuid())
    email         String    @default("")
    userId        String
    notifications           TeacherNotification[]
    worksheets              Worksheet[]
    publishedWorksheets     PublishedWorksheet[]

    @@index([userId])
}

model TeacherNotification {
    id            String            @id @default(cuid())
    text          String?
    time          DateTime?         @default(now())
    isRead        Boolean           @default(false)
    resource      String   
    profileId     String
    profile       TeacherProfile    @relation(fields: [profileId], references: [id], onDelete: Cascade, onUpdate: Cascade)

    @@index([profileId])
}

//  Utils Table
//  Image
model Image {
    id              String          @id @default(cuid())
    fileKey         String          @db.Text
    url             String          @db.VarChar(1024)
    caption         String          @db.VarChar(1024)    
    nestedQuestionId                String?  
    nestedQuestion                  NestedQuestion? @relation(fields: [nestedQuestionId], references: [id], onDelete: Cascade, onUpdate: Cascade)
    multipleChoiceQuestionId        String? 
    multipleChoiceQuestion          MultipleChoiceQuestion? @relation(fields: [multipleChoiceQuestionId], references: [id], onDelete: Cascade, onUpdate: Cascade)
    shortAnswerQuestionId           String? 
    shortAnswerQuestion             ShortAnswerQuestion?    @relation(fields: [shortAnswerQuestionId], references: [id], onDelete: Cascade, onUpdate: Cascade)
    openEndedQuestionId             String? 
    openEndedQuestion               OpenEndedQuestion?     @relation(fields: [openEndedQuestionId], references: [id], onDelete: Cascade, onUpdate: Cascade)
   
    @@index([nestedQuestionId])
    @@index([multipleChoiceQuestionId])
    @@index([shortAnswerQuestionId])
    @@index([openEndedQuestionId])
}

//  Worksheet, Published Worksheet and Answer Sheet
//
//  Worksheet - The actual worksheet that the teacher will edit on
//  Published Worksheet - Uneditable worksheet that is published from the worksheet.
//                        New published worksheet is created each time teacher creates a new version
//  Answer Sheet - The table that stores the user's answer to its corresponding questions

model Worksheet {
    id             String           @id @default(cuid())
    title          String           @db.TinyText
    lastEdited     DateTime         @updatedAt
    questions                       Question[]
    publishedWorksheets             PublishedWorksheet[]
    profileId      String
    profile        TeacherProfile   @relation(fields: [profileId], references: [id], onDelete: Cascade, onUpdate: Cascade)
   
    @@index([profileId])
}

model PublishedWorksheet {
    id             String               @id @default(cuid())
    title          String               @db.TinyText
    status         WorksheetStatus      @default(PRIVATE)
    version        Int          
    createdTime    DateTime             @default(now())
    totalMarks     Int 
    questions                    Question[]
    answerSheets                 AnswerSheet[]
    worksheetId      String?
    worksheet        Worksheet?          @relation(fields: [worksheetId], references: [id], onDelete: SetNull, onUpdate: SetNull)
    profileId        String?
    profile          TeacherProfile?     @relation(fields: [profileId], references: [id], onDelete: SetNull, onUpdate: SetNull)

    @@index([worksheetId])
    @@index([profileId])
}

enum WorksheetStatus {
    PUBLIC
    PRIVATE
}

model AnswerSheet {
    id                  String          @id @default(cuid())
    studentName         String          @db.TinyText
    studentEmail        String          @db.TinyText
    studentPassword     String?         //This should be stored in hash.
    status              AnswerSheetStatus 
    startTime           DateTime        @default(now())
    endTime             DateTime?
    totalMarks          Int?  
    answers             Answer[]   
    publishedWorksheetId         String @map("worksheetId")
    publishedWorksheet           PublishedWorksheet @relation(fields: [publishedWorksheetId], references: [id], onDelete: Cascade, onUpdate: Cascade)

    @@index([publishedWorksheetId])
}

enum AnswerSheetStatus {
    answering
    checking
    returned
}

// ***      Questions     ***

model Question {
    id                          String    @id @default(cuid())
    order                       Int   
    questionType                    QuestionType
    nestedQuestion                  NestedQuestion?     @relation(name: "NestedQuestion")
    multipleChoiceQuestion          MultipleChoiceQuestion?
    shortAnswerQuestion             ShortAnswerQuestion?
    openEndedQuestion               OpenEndedQuestion? 
    worksheetId                 String?
    worksheet                   Worksheet?              @relation(fields: [worksheetId], references: [id], onDelete: Cascade, onUpdate: Cascade)
    publishedWorksheetId        String?
    publishedWorksheet          PublishedWorksheet?     @relation(fields: [publishedWorksheetId], references: [id], onDelete: Cascade, onUpdate: Cascade)
    parentId                    String?
    parent                      NestedQuestion?         @relation(name: "ParentQuestion", fields: [parentId], references: [id], onDelete: Cascade, onUpdate: Cascade)


    @@index([worksheetId])
    @@index([publishedWorksheetId])
    @@index([parentId])
}

enum QuestionType {
    NestedQuestion
    MultipleChoiceQuestion
    ShortAnswerQuestion
    OpenEndedQuestion
}



//  Different types of questions
//  - Nested Question
//  - Multiple Choice Question
//  - Short Answer Question
//  - Open Ended Question
//  
//  Nested Question - A question that encompasses other question types as children. Also can be self-referential.
//  Multiple Choice Question - A question where student has to choose from one option. 
//  Short Answer Question - A question that student has to type in. Can be checked automatically based on answer
//  Open Ended Question - A question that student has to type in. Cannot be checked automatically. Only contains sample answer

model NestedQuestion {
    id                  String      @id @default(cuid())
    text                String      @db.Text
    images              Image[]
    
    // One-to-one relationship to question
    questionId          String?          @unique
    question            Question?        @relation(name: "NestedQuestion", fields: [questionId], references: [id], onDelete: NoAction, onUpdate: NoAction)
    // Self-Referential relation of parent and children
    // parentQuestionId    String?
    // parentQuestion      ParentQuestion?  @relation(fields: [parentQuestionId], references: [id], onDelete: NoAction, onUpdate: NoAction)
    childrenQuestions   Question[]       @relation(name: "ParentQuestion")
    

    // @@index([parentQuestionId])
    @@index([questionId])
}

model MultipleChoiceQuestion {
    id                  String      @id @default(cuid())
    text                String      @db.Text
    images              Image[]     
    answer              Int
    explanation         String      @db.Text
    marks               Int    
    choices             MultipleChoiceQuestionOption[]
    questionId          String?      @unique
    question            Question?    @relation(fields: [questionId], references: [id], onDelete: Cascade, onUpdate: Cascade)

    @@index([questionId])
}

model MultipleChoiceQuestionOption {
    id                  String          @id @default(cuid())
    index               Int
    text                String          @db.Text
    multipleChoiceQuestionChoiceId      String
    multipleChoiceQuestionChoice        MultipleChoiceQuestion @relation(fields: [multipleChoiceQuestionChoiceId], references: [id], onDelete: Cascade, onUpdate: Cascade)

    @@index([multipleChoiceQuestionChoiceId])
}

model ShortAnswerQuestion {
    id                  String          @id @default(cuid())
    text                String          @db.Text
    images              Image[]
    answer              String
    explanation         String
    marks               Int    
    
    questionId         String?   @unique
    question           Question? @relation(fields: [questionId], references: [id], onDelete: Cascade, onUpdate: Cascade)

    @@index([questionId])
}

model OpenEndedQuestion {
    id                  String      @id @default(cuid())
    text                String      @db.Text
    images              Image[]
    sampleAnswer        String      @db.MediumText
    explanation         String      @db.MediumText
    markingScheme       Json        @default("[]")  
    marks               Int
    questionId          String?     @unique
    question            Question?   @relation(fields: [questionId], references: [id], onDelete: Cascade, onUpdate: Cascade)

    @@index([questionId])
}


// ***      Answers     ***

model Answer {
    id                              String    @id @default(cuid())
    order                           Int   
    answerType                      AnswerType
    nestedQuestionAnswer            NestedQuestionAnswer?           @relation(name: "NestedAnswer")
    multipleChoiceQuestionAnswer    MultipleChoiceQuestionAnswer?
    shortAnswerQuestionAnswer       ShortAnswerQuestionAnswer?
    openEndedQuestionAnswer         OpenEndedQuestionAnswer?
    answerSheetId                   String?
    answerSheet                     AnswerSheet?                  @relation(fields: [answerSheetId], references: [id], onDelete: Cascade, onUpdate: Cascade)
    parentId                        String?
    parent                          NestedQuestionAnswer?         @relation(name: "ParentAnswer", fields: [parentId], references: [id], onDelete: NoAction, onUpdate: NoAction)

    @@index([answerSheetId])
    @@index([parentId])
}

enum AnswerType {
    MultipleChoiceQuestionAnswer
    ShortAnswerQuestionAnswer
    OpenEndedQuestionAnswer
    NestedQuestionAnswer
}

model NestedQuestionAnswer {
    id                    String    @id @default(cuid())
    // One-to-one relationship to question
    answerId              String    @unique
    answer                Answer    @relation(name: "NestedAnswer", fields: [answerId], references: [id], onDelete: Cascade, onUpdate: Cascade)
    // Many-to-one relationship to question
    childrenAnswers       Answer[]       @relation(name: "ParentAnswer")

    @@index([answerId])
}

model MultipleChoiceQuestionAnswer {
    id                    String    @id @default(cuid())
    studentAnswer         Int   
    feedback              String    @db.Text
    marks                 Int       @default(0)
    answerId              String    @unique
    answer                Answer    @relation(fields: [answerId], references: [id], onDelete: Cascade, onUpdate: Cascade)

    @@index([answerId])
}

model ShortAnswerQuestionAnswer {
    id                    String    @id @default(cuid())
    studentAnswer         String    @db.Text
    feedback              String    @db.Text
    marks                 Int       @default(0)
    answerId              String    @unique
    answer                Answer    @relation(fields: [answerId], references: [id], onDelete: Cascade, onUpdate: Cascade)

    @@index([answerId])
}

model OpenEndedQuestionAnswer {
    id                    String    @id @default(cuid())
    studentAnswer         String    @db.MediumText
    feedback              String    @db.Text
    marks                 Int       @default(0)
    answerId              String    @unique 
    answer                Answer    @relation(fields: [answerId], references: [id], onDelete: Cascade, onUpdate: Cascade)

    @@index([answerId])
}
